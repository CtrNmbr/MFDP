import json
from functools import partial
from typing import Callable

import pika
from sqlmodel import Session

from app.src.dto.predict_task_payload import PredictTaskPayload
from app.src.models.predict_task import PredictTask
from app.src.base.config import import_settings

QUEUE_NAME = "predict_tasks"


def get_rabbitmq_connection():
    settings = import_settings()

    credentials = pika.PlainCredentials(
        settings.RABBITMQ_USER, settings.RABBITMQ_PASSWORD
    )
    return pika.BlockingConnection(
        pika.ConnectionParameters(
            host=settings.RABBITMQ_HOST,
            port=settings.RABBITMQ_PORT,
            credentials=credentials,
        )
    )


def send_task_to_queue(task: PredictTask):

    with get_rabbitmq_connection() as connection:
        channel = connection.channel()
        channel.queue_declare(QUEUE_NAME, durable=True)

        payload = PredictTaskPayload(
            id=task.id,
            user_id=task.user_id,
            TransactionID=task.TransactionID,
            id_01=task.id_01,
            id_02=task.id_02,
            id_03=task.id_03,
            id_04=task.id_04,
            id_05=task.id_05,
            id_06=task.id_06,
            id_07=task.id_07,
            id_08=task.id_08,
            id_09=task.id_09,
            id_10=task.id_10,
            id_11=task.id_11,
            id_12=task.id_12,
            id_13=task.id_13,
            id_14=task.id_14,
            id_15=task.id_15,
            id_16=task.id_16,
            id_17=task.id_17,
            id_18=task.id_18,
            id_19=task.id_19,
            id_20=task.id_20,
            id_21=task.id_21,
            id_22=task.id_22,
            id_23=task.id_23,
            id_24=task.id_24,
            id_25=task.id_25,
            id_26=task.id_26,
            id_27=task.id_27,
            id_28=task.id_28,
            id_29=task.id_29,
            id_30=task.id_30,
            id_31=task.id_31,
            id_32=task.id_32,
            id_33=task.id_33,
            id_34=task.id_34,
            id_35=task.id_35,
            id_36=task.id_36,
            id_37=task.id_37,
            id_38=task.id_38,
            DeviceType=task.DeviceType,
            DeviceInfo=task.DeviceInfo,
            TransactionDT=task.TransactionDT,
            TransactionAmt=task.TransactionAmt,
            ProductCD=task.ProductCD,
            card1=task.card1,
            card2=task.card2,
            card3=task.card3,
            card4=task.card4,
            card5=task.card5,
            card6=task.card6,
            addr1=task.addr1,
            addr2=task.addr2,
            dist1=task.dist1,
            dist2=task.dist2,
            P_emaildomain=task.P_emaildomain,
            R_emaildomain=task.R_emaildomain,
            C1=task.C1,
            C2=task.C2,
            C3=task.C3,
            C4=task.C4,
            C5=task.C5,
            C6=task.C6,
            C7=task.C7,
            C8=task.C8,
            C9=task.C9,
            C10=task.C10,
            C11=task.C11,
            C12=task.C12,
            C13=task.C13,
            C14=task.C14,
            D1=task.D1,
            D2=task.D2,
            D3=task.D3,
            D4=task.D4,
            D5=task.D5,
            D6=task.D6,
            D7=task.D7,
            D8=task.D8,
            D9=task.D9,
            D10=task.D10,
            D11=task.D11,
            D12=task.D12,
            D13=task.D13,
            D14=task.D14,
            D15=task.D15,
            M1=task.M1,
            M2=task.M2,
            M3=task.M3,
            M4=task.M4,
            M5=task.M5,
            M6=task.M6,
            M7=task.M7,
            M8=task.M8,
            M9=task.M9,
            V1=task.V1,
            V2=task.V2,
            V3=task.V3,
            V4=task.V4,
            V5=task.V5,
            V6=task.V6,
            V7=task.V7,
            V8=task.V8,
            V9=task.V9,
            V10=task.V10,
            V11=task.V11,
            V12=task.V12,
            V13=task.V13,
            V14=task.V14,
            V15=task.V15,
            V16=task.V16,
            V17=task.V17,
            V18=task.V18,
            V19=task.V19,
            V20=task.V20,
            V21=task.V21,
            V22=task.V22,
            V23=task.V23,
            V24=task.V24,
            V25=task.V25,
            V26=task.V26,
            V27=task.V27,
            V28=task.V28,
            V29=task.V29,
            V30=task.V30,
            V31=task.V31,
            V32=task.V32,
            V33=task.V33,
            V34=task.V34,
            V35=task.V35,
            V36=task.V36,
            V37=task.V37,
            V38=task.V38,
            V39=task.V39,
            V40=task.V40,
            V41=task.V41,
            V42=task.V42,
            V43=task.V43,
            V44=task.V44,
            V45=task.V45,
            V46=task.V46,
            V47=task.V47,
            V48=task.V48,
            V49=task.V49,
            V50=task.V50,
            V51=task.V51,
            V52=task.V52,
            V53=task.V53,
            V54=task.V54,
            V55=task.V55,
            V56=task.V56,
            V57=task.V57,
            V58=task.V58,
            V59=task.V59,
            V60=task.V60,
            V61=task.V61,
            V62=task.V62,
            V63=task.V63,
            V64=task.V64,
            V65=task.V65,
            V66=task.V66,
            V67=task.V67,
            V68=task.V68,
            V69=task.V69,
            V70=task.V70,
            V71=task.V71,
            V72=task.V72,
            V73=task.V73,
            V74=task.V74,
            V75=task.V75,
            V76=task.V76,
            V77=task.V77,
            V78=task.V78,
            V79=task.V79,
            V80=task.V80,
            V81=task.V81,
            V82=task.V82,
            V83=task.V83,
            V84=task.V84,
            V85=task.V85,
            V86=task.V86,
            V87=task.V87,
            V88=task.V88,
            V89=task.V89,
            V90=task.V90,
            V91=task.V91,
            V92=task.V92,
            V93=task.V93,
            V94=task.V94,
            V95=task.V95,
            V96=task.V96,
            V97=task.V97,
            V98=task.V98,
            V99=task.V99,
            V100=task.V100,
            V101=task.V101,
            V102=task.V102,
            V103=task.V103,
            V104=task.V104,
            V105=task.V105,
            V106=task.V106,
            V107=task.V107,
            V108=task.V108,
            V109=task.V109,
            V110=task.V110,
            V111=task.V111,
            V112=task.V112,
            V113=task.V113,
            V114=task.V114,
            V115=task.V115,
            V116=task.V116,
            V117=task.V117,
            V118=task.V118,
            V119=task.V119,
            V120=task.V120,
            V121=task.V121,
            V122=task.V122,
            V123=task.V123,
            V124=task.V124,
            V125=task.V125,
            V126=task.V126,
            V127=task.V127,
            V128=task.V128,
            V129=task.V129,
            V130=task.V130,
            V131=task.V131,
            V132=task.V132,
            V133=task.V133,
            V134=task.V134,
            V135=task.V135,
            V136=task.V136,
            V137=task.V137,
            V138=task.V138,
            V139=task.V139,
            V140=task.V140,
            V141=task.V141,
            V142=task.V142,
            V143=task.V143,
            V144=task.V144,
            V145=task.V145,
            V146=task.V146,
            V147=task.V147,
            V148=task.V148,
            V149=task.V149,
            V150=task.V150,
            V151=task.V151,
            V152=task.V152,
            V153=task.V153,
            V154=task.V154,
            V155=task.V155,
            V156=task.V156,
            V157=task.V157,
            V158=task.V158,
            V159=task.V159,
            V160=task.V160,
            V161=task.V161,
            V162=task.V162,
            V163=task.V163,
            V164=task.V164,
            V165=task.V165,
            V166=task.V166,
            V167=task.V167,
            V168=task.V168,
            V169=task.V169,
            V170=task.V170,
            V171=task.V171,
            V172=task.V172,
            V173=task.V173,
            V174=task.V174,
            V175=task.V175,
            V176=task.V176,
            V177=task.V177,
            V178=task.V178,
            V179=task.V179,
            V180=task.V180,
            V181=task.V181,
            V182=task.V182,
            V183=task.V183,
            V184=task.V184,
            V185=task.V185,
            V186=task.V186,
            V187=task.V187,
            V188=task.V188,
            V189=task.V189,
            V190=task.V190,
            V191=task.V191,
            V192=task.V192,
            V193=task.V193,
            V194=task.V194,
            V195=task.V195,
            V196=task.V196,
            V197=task.V197,
            V198=task.V198,
            V199=task.V199,
            V200=task.V200,
            V201=task.V201,
            V202=task.V202,
            V203=task.V203,
            V204=task.V204,
            V205=task.V205,
            V206=task.V206,
            V207=task.V207,
            V208=task.V208,
            V209=task.V209,
            V210=task.V210,
            V211=task.V211,
            V212=task.V212,
            V213=task.V213,
            V214=task.V214,
            V215=task.V215,
            V216=task.V216,
            V217=task.V217,
            V218=task.V218,
            V219=task.V219,
            V220=task.V220,
            V221=task.V221,
            V222=task.V222,
            V223=task.V223,
            V224=task.V224,
            V225=task.V225,
            V226=task.V226,
            V227=task.V227,
            V228=task.V228,
            V229=task.V229,
            V230=task.V230,
            V231=task.V231,
            V232=task.V232,
            V233=task.V233,
            V234=task.V234,
            V235=task.V235,
            V236=task.V236,
            V237=task.V237,
            V238=task.V238,
            V239=task.V239,
            V240=task.V240,
            V241=task.V241,
            V242=task.V242,
            V243=task.V243,
            V244=task.V244,
            V245=task.V245,
            V246=task.V246,
            V247=task.V247,
            V248=task.V248,
            V249=task.V249,
            V250=task.V250,
            V251=task.V251,
            V252=task.V252,
            V253=task.V253,
            V254=task.V254,
            V255=task.V255,
            V256=task.V256,
            V257=task.V257,
            V258=task.V258,
            V259=task.V259,
            V260=task.V260,
            V261=task.V261,
            V262=task.V262,
            V263=task.V263,
            V264=task.V264,
            V265=task.V265,
            V266=task.V266,
            V267=task.V267,
            V268=task.V268,
            V269=task.V269,
            V270=task.V270,
            V271=task.V271,
            V272=task.V272,
            V273=task.V273,
            V274=task.V274,
            V275=task.V275,
            V276=task.V276,
            V277=task.V277,
            V278=task.V278,
            V279=task.V279,
            V280=task.V280,
            V281=task.V281,
            V282=task.V282,
            V283=task.V283,
            V284=task.V284,
            V285=task.V285,
            V286=task.V286,
            V287=task.V287,
            V288=task.V288,
            V289=task.V289,
            V290=task.V290,
            V291=task.V291,
            V292=task.V292,
            V293=task.V293,
            V294=task.V294,
            V295=task.V295,
            V296=task.V296,
            V297=task.V297,
            V298=task.V298,
            V299=task.V299,
            V300=task.V300,
            V301=task.V301,
            V302=task.V302,
            V303=task.V303,
            V304=task.V304,
            V305=task.V305,
            V306=task.V306,
            V307=task.V307,
            V308=task.V308,
            V309=task.V309,
            V310=task.V310,
            V311=task.V311,
            V312=task.V312,
            V313=task.V313,
            V314=task.V314,
            V315=task.V315,
            V316=task.V316,
            V317=task.V317,
            V318=task.V318,
            V319=task.V319,
            V320=task.V320,
            V321=task.V321,
            V322=task.V322,
            V323=task.V323,
            V324=task.V324,
            V325=task.V325,
            V326=task.V326,
            V327=task.V327,
            V328=task.V328,
            V329=task.V329,
            V330=task.V330,
            V331=task.V331,
            V332=task.V332,
            V333=task.V333,
            V334=task.V334,
            V335=task.V335,
            V336=task.V336,
            V337=task.V337,
            V338=task.V338,
            V339=task.V339,
            account_transaction_id=task.account_transaction_id,
        )

        message = payload.model_dump_json()

        channel.basic_publish(
            exchange="",
            routing_key=QUEUE_NAME,
            body=message,
            properties=pika.BasicProperties(
                delivery_mode=2,
            ),
        )


def start_consuming_tasks(task_processor: Callable, session: Session):
    with get_rabbitmq_connection() as connection:
        channel = connection.channel()
        channel.queue_declare(queue=QUEUE_NAME, durable=True)

        channel.basic_qos(prefetch_count=1)
        channel.basic_consume(
            queue=QUEUE_NAME,
            on_message_callback=partial(task_processor, session=session),
        )

        print("Consuming started. Waiting for tasks...")
        channel.start_consuming()
