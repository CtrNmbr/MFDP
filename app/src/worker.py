import json
from datetime import datetime, timezone
from pathlib import Path
from dotenv import load_dotenv
from opyoid import Module, Injector
from sqlmodel import Session

from app.src.base.model_starter import get_model
from app.src.base.constants import TaskStatus
from app.src.database.database import engine
from app.src.models.predict_task import PredictTask
from app.src.models.quality_prediction import QualityPrediction
from app.src.services.account_service import AccountService
from app.src.services.crud.prediction import create_prediction
from app.src.services.rabbitmq_task_service import (
    start_consuming_tasks,
    PredictTaskPayload,
)
from app.src.services.transaction_service import TransactionService
from app.src.services.crud.predict_task import update_predict_task

# Загрузка переменных окружения из .env файла, если он существует
env_path = Path(__file__).parent.parent.parent / ".env"
if env_path.exists():
    load_dotenv(env_path)


def process_predict_task(ch, method, properties, body, session: Session):
    data = PredictTaskPayload.model_validate_json(body) # проверяет по алиасам
    print(f"Received task: {data}")

    account_service = AccountService(TransactionService())
    predict_task = PredictTask(id=data.id, status=TaskStatus.IN_PROGRESS)

    update_predict_task(predict_task, session)

    try:
        model = get_model() #
        filtered_data = json.loads(data.model_dump_json(by_alias=True))#{key: value for key, value in data.model_dump_json(by_alias=True).items() if key in ['fixed_acidity','volatile_acidity','citric_acid','residual_sugar','chlorides','free_sulfur_dioxide','total_sulfur_dioxide','density','pH','sulphates','alcohol']}
        #worker-2     | AttributeError: 'PredictTaskPayload' object has no attribute 'items'
        print("dict aliased is ",filtered_data)
        filtered_data = {key.replace("_"," "): value for key, value in filtered_data.items() if key in ["TransactionID",
"id_01",
"id_02",
"id_03",
"id_04",
"id_05",
"id_06",
"id_07",
"id_08",
"id_09",
"id_10",
"id_11",
"id_12",
"id_13",
"id_14",
"id_15",
"id_16",
"id_17",
"id_18",
"id_19",
"id_20",
"id_21",
"id_22",
"id_23",
"id_24",
"id_25",
"id_26",
"id_27",
"id_28",
"id_29",
"id_30",
"id_31",
"id_32",
"id_33",
"id_34",
"id_35",
"id_36",
"id_37",
"id_38",
"DeviceType",
"DeviceInfo",
"TransactionDT",
"TransactionAmt",
"ProductCD",
"card1",
"card2",
"card3",
"card4",
"card5",
"card6",
"addr1",
"addr2",
"dist1",
"dist2",
"P_emaildomain",
"R_emaildomain",
"C1",
"C2",
"C3",
"C4",
"C5",
"C6",
"C7",
"C8",
"C9",
"C10",
"C11",
"C12",
"C13",
"C14",
"D1",
"D2",
"D3",
"D4",
"D5",
"D6",
"D7",
"D8",
"D9",
"D10",
"D11",
"D12",
"D13",
"D14",
"D15",
"M1",
"M2",
"M3",
"M4",
"M5",
"M6",
"M7",
"M8",
"M9",
"V1",
"V2",
"V3",
"V4",
"V5",
"V6",
"V7",
"V8",
"V9",
"V10",
"V11",
"V12",
"V13",
"V14",
"V15",
"V16",
"V17",
"V18",
"V19",
"V20",
"V21",
"V22",
"V23",
"V24",
"V25",
"V26",
"V27",
"V28",
"V29",
"V30",
"V31",
"V32",
"V33",
"V34",
"V35",
"V36",
"V37",
"V38",
"V39",
"V40",
"V41",
"V42",
"V43",
"V44",
"V45",
"V46",
"V47",
"V48",
"V49",
"V50",
"V51",
"V52",
"V53",
"V54",
"V55",
"V56",
"V57",
"V58",
"V59",
"V60",
"V61",
"V62",
"V63",
"V64",
"V65",
"V66",
"V67",
"V68",
"V69",
"V70",
"V71",
"V72",
"V73",
"V74",
"V75",
"V76",
"V77",
"V78",
"V79",
"V80",
"V81",
"V82",
"V83",
"V84",
"V85",
"V86",
"V87",
"V88",
"V89",
"V90",
"V91",
"V92",
"V93",
"V94",
"V95",
"V96",
"V97",
"V98",
"V99",
"V100",
"V101",
"V102",
"V103",
"V104",
"V105",
"V106",
"V107",
"V108",
"V109",
"V110",
"V111",
"V112",
"V113",
"V114",
"V115",
"V116",
"V117",
"V118",
"V119",
"V120",
"V121",
"V122",
"V123",
"V124",
"V125",
"V126",
"V127",
"V128",
"V129",
"V130",
"V131",
"V132",
"V133",
"V134",
"V135",
"V136",
"V137",
"V138",
"V139",
"V140",
"V141",
"V142",
"V143",
"V144",
"V145",
"V146",
"V147",
"V148",
"V149",
"V150",
"V151",
"V152",
"V153",
"V154",
"V155",
"V156",
"V157",
"V158",
"V159",
"V160",
"V161",
"V162",
"V163",
"V164",
"V165",
"V166",
"V167",
"V168",
"V169",
"V170",
"V171",
"V172",
"V173",
"V174",
"V175",
"V176",
"V177",
"V178",
"V179",
"V180",
"V181",
"V182",
"V183",
"V184",
"V185",
"V186",
"V187",
"V188",
"V189",
"V190",
"V191",
"V192",
"V193",
"V194",
"V195",
"V196",
"V197",
"V198",
"V199",
"V200",
"V201",
"V202",
"V203",
"V204",
"V205",
"V206",
"V207",
"V208",
"V209",
"V210",
"V211",
"V212",
"V213",
"V214",
"V215",
"V216",
"V217",
"V218",
"V219",
"V220",
"V221",
"V222",
"V223",
"V224",
"V225",
"V226",
"V227",
"V228",
"V229",
"V230",
"V231",
"V232",
"V233",
"V234",
"V235",
"V236",
"V237",
"V238",
"V239",
"V240",
"V241",
"V242",
"V243",
"V244",
"V245",
"V246",
"V247",
"V248",
"V249",
"V250",
"V251",
"V252",
"V253",
"V254",
"V255",
"V256",
"V257",
"V258",
"V259",
"V260",
"V261",
"V262",
"V263",
"V264",
"V265",
"V266",
"V267",
"V268",
"V269",
"V270",
"V271",
"V272",
"V273",
"V274",
"V275",
"V276",
"V277",
"V278",
"V279",
"V280",
"V281",
"V282",
"V283",
"V284",
"V285",
"V286",
"V287",
"V288",
"V289",
"V290",
"V291",
"V292",
"V293",
"V294",
"V295",
"V296",
"V297",
"V298",
"V299",
"V300",
"V301",
"V302",
"V303",
"V304",
"V305",
"V306",
"V307",
"V308",
"V309",
"V310",
"V311",
"V312",
"V313",
"V314",
"V315",
"V316",
"V317",
"V318",
"V319",
"V320",
"V321",
"V322",
"V323",
"V324",
"V325",
"V326",
"V327",
"V328",
"V329",
"V330",
"V331",
"V332",
"V333",
"V334",
"V335",
"V336",
"V337",
"V338",
"V339",]}
        # надо менять нейминги при подстановке
        # todo заменить на подjson
        result = model.predict_result(filtered_data)

        #account_service.create_payment(data.user_id, session) # predict сразу с оплатой - была двойная!

        prediction = QualityPrediction(
            user_id=data.user_id,
            TransactionID=data.TransactionID,
            id_01=data.id_01,
            id_02=data.id_02,
            id_03=data.id_03,
            id_04=data.id_04,
            id_05=data.id_05,
            id_06=data.id_06,
            id_07=data.id_07,
            id_08=data.id_08,
            id_09=data.id_09,
            id_10=data.id_10,
            id_11=data.id_11,
            id_12=data.id_12,
            id_13=data.id_13,
            id_14=data.id_14,
            id_15=data.id_15,
            id_16=data.id_16,
            id_17=data.id_17,
            id_18=data.id_18,
            id_19=data.id_19,
            id_20=data.id_20,
            id_21=data.id_21,
            id_22=data.id_22,
            id_23=data.id_23,
            id_24=data.id_24,
            id_25=data.id_25,
            id_26=data.id_26,
            id_27=data.id_27,
            id_28=data.id_28,
            id_29=data.id_29,
            id_30=data.id_30,
            id_31=data.id_31,
            id_32=data.id_32,
            id_33=data.id_33,
            id_34=data.id_34,
            id_35=data.id_35,
            id_36=data.id_36,
            id_37=data.id_37,
            id_38=data.id_38,
            DeviceType=data.DeviceType,
            DeviceInfo=data.DeviceInfo,
            TransactionDT=data.TransactionDT,
            TransactionAmt=data.TransactionAmt,
            ProductCD=data.ProductCD,
            card1=data.card1,
            card2=data.card2,
            card3=data.card3,
            card4=data.card4,
            card5=data.card5,
            card6=data.card6,
            addr1=data.addr1,
            addr2=data.addr2,
            dist1=data.dist1,
            dist2=data.dist2,
            P_emaildomain=data.P_emaildomain,
            R_emaildomain=data.R_emaildomain,
            C1=data.C1,
            C2=data.C2,
            C3=data.C3,
            C4=data.C4,
            C5=data.C5,
            C6=data.C6,
            C7=data.C7,
            C8=data.C8,
            C9=data.C9,
            C10=data.C10,
            C11=data.C11,
            C12=data.C12,
            C13=data.C13,
            C14=data.C14,
            D1=data.D1,
            D2=data.D2,
            D3=data.D3,
            D4=data.D4,
            D5=data.D5,
            D6=data.D6,
            D7=data.D7,
            D8=data.D8,
            D9=data.D9,
            D10=data.D10,
            D11=data.D11,
            D12=data.D12,
            D13=data.D13,
            D14=data.D14,
            D15=data.D15,
            M1=data.M1,
            M2=data.M2,
            M3=data.M3,
            M4=data.M4,
            M5=data.M5,
            M6=data.M6,
            M7=data.M7,
            M8=data.M8,
            M9=data.M9,
            V1=data.V1,
            V2=data.V2,
            V3=data.V3,
            V4=data.V4,
            V5=data.V5,
            V6=data.V6,
            V7=data.V7,
            V8=data.V8,
            V9=data.V9,
            V10=data.V10,
            V11=data.V11,
            V12=data.V12,
            V13=data.V13,
            V14=data.V14,
            V15=data.V15,
            V16=data.V16,
            V17=data.V17,
            V18=data.V18,
            V19=data.V19,
            V20=data.V20,
            V21=data.V21,
            V22=data.V22,
            V23=data.V23,
            V24=data.V24,
            V25=data.V25,
            V26=data.V26,
            V27=data.V27,
            V28=data.V28,
            V29=data.V29,
            V30=data.V30,
            V31=data.V31,
            V32=data.V32,
            V33=data.V33,
            V34=data.V34,
            V35=data.V35,
            V36=data.V36,
            V37=data.V37,
            V38=data.V38,
            V39=data.V39,
            V40=data.V40,
            V41=data.V41,
            V42=data.V42,
            V43=data.V43,
            V44=data.V44,
            V45=data.V45,
            V46=data.V46,
            V47=data.V47,
            V48=data.V48,
            V49=data.V49,
            V50=data.V50,
            V51=data.V51,
            V52=data.V52,
            V53=data.V53,
            V54=data.V54,
            V55=data.V55,
            V56=data.V56,
            V57=data.V57,
            V58=data.V58,
            V59=data.V59,
            V60=data.V60,
            V61=data.V61,
            V62=data.V62,
            V63=data.V63,
            V64=data.V64,
            V65=data.V65,
            V66=data.V66,
            V67=data.V67,
            V68=data.V68,
            V69=data.V69,
            V70=data.V70,
            V71=data.V71,
            V72=data.V72,
            V73=data.V73,
            V74=data.V74,
            V75=data.V75,
            V76=data.V76,
            V77=data.V77,
            V78=data.V78,
            V79=data.V79,
            V80=data.V80,
            V81=data.V81,
            V82=data.V82,
            V83=data.V83,
            V84=data.V84,
            V85=data.V85,
            V86=data.V86,
            V87=data.V87,
            V88=data.V88,
            V89=data.V89,
            V90=data.V90,
            V91=data.V91,
            V92=data.V92,
            V93=data.V93,
            V94=data.V94,
            V95=data.V95,
            V96=data.V96,
            V97=data.V97,
            V98=data.V98,
            V99=data.V99,
            V100=data.V100,
            V101=data.V101,
            V102=data.V102,
            V103=data.V103,
            V104=data.V104,
            V105=data.V105,
            V106=data.V106,
            V107=data.V107,
            V108=data.V108,
            V109=data.V109,
            V110=data.V110,
            V111=data.V111,
            V112=data.V112,
            V113=data.V113,
            V114=data.V114,
            V115=data.V115,
            V116=data.V116,
            V117=data.V117,
            V118=data.V118,
            V119=data.V119,
            V120=data.V120,
            V121=data.V121,
            V122=data.V122,
            V123=data.V123,
            V124=data.V124,
            V125=data.V125,
            V126=data.V126,
            V127=data.V127,
            V128=data.V128,
            V129=data.V129,
            V130=data.V130,
            V131=data.V131,
            V132=data.V132,
            V133=data.V133,
            V134=data.V134,
            V135=data.V135,
            V136=data.V136,
            V137=data.V137,
            V138=data.V138,
            V139=data.V139,
            V140=data.V140,
            V141=data.V141,
            V142=data.V142,
            V143=data.V143,
            V144=data.V144,
            V145=data.V145,
            V146=data.V146,
            V147=data.V147,
            V148=data.V148,
            V149=data.V149,
            V150=data.V150,
            V151=data.V151,
            V152=data.V152,
            V153=data.V153,
            V154=data.V154,
            V155=data.V155,
            V156=data.V156,
            V157=data.V157,
            V158=data.V158,
            V159=data.V159,
            V160=data.V160,
            V161=data.V161,
            V162=data.V162,
            V163=data.V163,
            V164=data.V164,
            V165=data.V165,
            V166=data.V166,
            V167=data.V167,
            V168=data.V168,
            V169=data.V169,
            V170=data.V170,
            V171=data.V171,
            V172=data.V172,
            V173=data.V173,
            V174=data.V174,
            V175=data.V175,
            V176=data.V176,
            V177=data.V177,
            V178=data.V178,
            V179=data.V179,
            V180=data.V180,
            V181=data.V181,
            V182=data.V182,
            V183=data.V183,
            V184=data.V184,
            V185=data.V185,
            V186=data.V186,
            V187=data.V187,
            V188=data.V188,
            V189=data.V189,
            V190=data.V190,
            V191=data.V191,
            V192=data.V192,
            V193=data.V193,
            V194=data.V194,
            V195=data.V195,
            V196=data.V196,
            V197=data.V197,
            V198=data.V198,
            V199=data.V199,
            V200=data.V200,
            V201=data.V201,
            V202=data.V202,
            V203=data.V203,
            V204=data.V204,
            V205=data.V205,
            V206=data.V206,
            V207=data.V207,
            V208=data.V208,
            V209=data.V209,
            V210=data.V210,
            V211=data.V211,
            V212=data.V212,
            V213=data.V213,
            V214=data.V214,
            V215=data.V215,
            V216=data.V216,
            V217=data.V217,
            V218=data.V218,
            V219=data.V219,
            V220=data.V220,
            V221=data.V221,
            V222=data.V222,
            V223=data.V223,
            V224=data.V224,
            V225=data.V225,
            V226=data.V226,
            V227=data.V227,
            V228=data.V228,
            V229=data.V229,
            V230=data.V230,
            V231=data.V231,
            V232=data.V232,
            V233=data.V233,
            V234=data.V234,
            V235=data.V235,
            V236=data.V236,
            V237=data.V237,
            V238=data.V238,
            V239=data.V239,
            V240=data.V240,
            V241=data.V241,
            V242=data.V242,
            V243=data.V243,
            V244=data.V244,
            V245=data.V245,
            V246=data.V246,
            V247=data.V247,
            V248=data.V248,
            V249=data.V249,
            V250=data.V250,
            V251=data.V251,
            V252=data.V252,
            V253=data.V253,
            V254=data.V254,
            V255=data.V255,
            V256=data.V256,
            V257=data.V257,
            V258=data.V258,
            V259=data.V259,
            V260=data.V260,
            V261=data.V261,
            V262=data.V262,
            V263=data.V263,
            V264=data.V264,
            V265=data.V265,
            V266=data.V266,
            V267=data.V267,
            V268=data.V268,
            V269=data.V269,
            V270=data.V270,
            V271=data.V271,
            V272=data.V272,
            V273=data.V273,
            V274=data.V274,
            V275=data.V275,
            V276=data.V276,
            V277=data.V277,
            V278=data.V278,
            V279=data.V279,
            V280=data.V280,
            V281=data.V281,
            V282=data.V282,
            V283=data.V283,
            V284=data.V284,
            V285=data.V285,
            V286=data.V286,
            V287=data.V287,
            V288=data.V288,
            V289=data.V289,
            V290=data.V290,
            V291=data.V291,
            V292=data.V292,
            V293=data.V293,
            V294=data.V294,
            V295=data.V295,
            V296=data.V296,
            V297=data.V297,
            V298=data.V298,
            V299=data.V299,
            V300=data.V300,
            V301=data.V301,
            V302=data.V302,
            V303=data.V303,
            V304=data.V304,
            V305=data.V305,
            V306=data.V306,
            V307=data.V307,
            V308=data.V308,
            V309=data.V309,
            V310=data.V310,
            V311=data.V311,
            V312=data.V312,
            V313=data.V313,
            V314=data.V314,
            V315=data.V315,
            V316=data.V316,
            V317=data.V317,
            V318=data.V318,
            V319=data.V319,
            V320=data.V320,
            V321=data.V321,
            V322=data.V322,
            V323=data.V323,
            V324=data.V324,
            V325=data.V325,
            V326=data.V326,
            V327=data.V327,
            V328=data.V328,
            V329=data.V329,
            V330=data.V330,
            V331=data.V331,
            V332=data.V332,
            V333=data.V333,
            V334=data.V334,
            V335=data.V335,
            V336=data.V336,
            V337=data.V337,
            V338=data.V338,
            V339=data.V339,
            isFraud=result,
            created_at=datetime.now(timezone.utc)
        )

        prediction = create_prediction(prediction, session)

        # upd task
        predict_task.status = TaskStatus.COMPLETED
        predict_task.predicted_quality = prediction.predicted_quality
        update_predict_task(predict_task, session)
    except Exception:
        predict_task.predicted_quality = "Ошибка выполнения. Кредиты будут возвращены"
        predict_task.status = TaskStatus.FAILED
        update_predict_task(predict_task, session)
        account_service.cancel_payment(data.user_id, session)

    ch.basic_ack(delivery_tag=method.delivery_tag)
    print(f"Predict task id: {predict_task.id} processed")


class Worker:
    def __init__(self, session: Session):
        self.session = session

    def start(self):
        start_consuming_tasks(process_predict_task, self.session)


class WorkerModule(Module):
    def configure(self) -> None:
        self.bind(Session, to_instance=Session(engine))
        self.bind(Worker)


if __name__ == "__main__":
    injector = Injector(modules=[WorkerModule()])
    worker = injector.inject(Worker)
    worker.start()
